name: Publish Docker Image
on:
  workflow_run:
    workflows: ["CI/CD"]
    types:
      - completed
    # Only publish Docker image on main branch and when not a pull request
    branches: ["main"]

permissions:
  contents: read
  # Required for test result publishing:
  checks: write
  pull-requests: write

jobs:
  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Extract version from package.json
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp:latest
            ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp:${{ steps.package-version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update workflow summary and log success
        if: success()
        run: |
          echo "::notice::Successfully published Docker image ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp:${{ steps.package-version.outputs.VERSION }}"
          echo "=========================================="
          echo "ðŸŽ‰ SUCCESSFUL DOCKER IMAGE PUBLICATION"
          echo "=========================================="
          echo "Image: ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp"
          echo "Version: ${{ steps.package-version.outputs.VERSION }}"
          echo "Tags: latest, ${{ steps.package-version.outputs.VERSION }}"
          echo "Pull with: docker pull ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp:latest"
          echo "=========================================="
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸŽ‰ Docker Image Publication Successful

          - **Image**: ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp
          - **Version**: ${{ steps.package-version.outputs.VERSION }}
          - **Tags**: latest, ${{ steps.package-version.outputs.VERSION }}
          - **Pull**: \`docker pull ${{ secrets.DOCKER_HUB_USER }}/simplifier-mcp:latest\`
          EOF
